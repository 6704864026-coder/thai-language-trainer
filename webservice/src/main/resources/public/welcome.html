<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Class 3-E - Mission</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Fredoka', sans-serif; background-color: #1a1a1a; overflow-x: hidden; }
        
        .chalkboard-bg {
            background-color: #1a1a1a;
            background-image: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.05) 0%, transparent 60%),
            url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        }
        
        .handwritten { font-family: 'Patrick Hand', cursive; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .flipped { transform: rotateY(180deg); }

        /* Grid Item Styles */
        .grid-item {
            border: 1px dashed rgba(255,255,255,0.2);
            transition: all 0.2s;
        }
        .grid-item.active {
            border: 2px solid #fff; 
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            color: #fff;
            opacity: 1 !important;
            z-index: 10;
        }
        /* Style for Mastered/Learned Cards */
        .grid-item.mastered {
            background-color: #FCD34D; /* Gold/Yellow */
            color: black;
            border: 1px solid #F59E0B;
            font-weight: bold;
            opacity: 1 !important;
            box-shadow: 0 0 5px #FCD34D;
        }
        .grid-item.unlocked {
            opacity: 0.5;
            background: rgba(255,255,255,0.1);
            cursor: pointer;
        }
        .grid-item.unlocked:hover {
            opacity: 1;
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
        }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        .custom-scroll::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    </style>
</head>
<body class="chalkboard-bg min-h-screen flex flex-col text-white">
    
    <header class="flex items-center justify-between p-4 border-b border-white/10 bg-black/20 backdrop-blur-md sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-yellow-300 border-2 border-black flex items-center justify-center">
                <div class="w-1 h-3 bg-black rounded-full mx-0.5"></div>
                <div class="w-1 h-3 bg-black rounded-full mx-0.5"></div>
            </div>
            <div>
                <h1 class="font-bold text-yellow-400 text-lg leading-none">Class 3-E</h1>
                <p class="text-xs text-gray-400">Agent: <span id="userDisplay">...</span></p>
            </div>
        </div>
        <button onclick="logout()" class="p-2 hover:bg-white/10 rounded-full transition"><i class="ph ph-sign-out text-xl"></i></button>
    </header>

    <main class="flex-1 flex flex-col md:flex-row items-center justify-center p-4 max-w-6xl mx-auto w-full gap-8">
        
        <div class="w-full md:w-1/3 flex flex-col gap-4 order-2 md:order-1">
            <div class="bg-white/5 border border-white/10 rounded-xl p-4 h-[400px] flex flex-col shadow-xl">
                <h3 class="text-yellow-400 font-bold mb-3 handwritten text-xl flex justify-between">
                    <span>Target List</span>
                    <div class="text-xs font-sans text-gray-400 flex flex-col items-end">
                        <span>Unlocked: <span id="counter" class="text-white">0</span>/44</span>
                        <span class="text-yellow-400">Mastered: <span id="masterCounter">0</span>/44</span>
                    </div>
                </h3>
                
                <div id="gridContainer" class="grid grid-cols-5 gap-2 overflow-y-auto custom-scroll pr-2 flex-1">
                    </div>
                
                <div class="mt-3 text-center text-xs text-gray-500">
                    * Gold = Mastered | Click to review
                </div>
            </div>
        </div>

        <div class="w-full md:w-2/3 flex flex-col items-center order-1 md:order-2">
            
            <div class="w-full mb-4 flex justify-between items-end max-w-md">
                <div class="text-4xl font-bold text-gray-500 opacity-20 font-serif italic">MISSION</div>
                <div class="bg-white text-black rounded-2xl rounded-bl-none px-4 py-2 max-w-xs text-sm handwritten relative mb-4 animate-bounce">
                    "Nurufufufu... translate this!"
                    <div class="absolute bottom-0 left-0 transform translate-y-1/2 -translate-x-0 w-3 h-3 bg-white rotate-45"></div>
                </div>
            </div>

            <div id="cardContainer" class="relative w-full max-w-md h-96 cursor-pointer perspective-1000 group" onclick="flipCard()">
                <div id="cardInner" class="relative w-full h-full transition-transform duration-500 transform-style-3d">
                    
                    <div class="absolute w-full h-full backface-hidden rounded-xl shadow-2xl border-4 border-gray-600 flex flex-col items-center justify-center p-6 bg-[#2a2a2a]">
                        <span class="text-yellow-500 text-sm font-bold tracking-widest uppercase mb-4">Target</span>
                        <h2 id="cardFront" class="text-8xl text-white handwritten text-center leading-relaxed">?</h2>
                        <p class="mt-8 text-gray-500 text-sm animate-pulse">Tap to reveal</p>
                    </div>

                    <div class="absolute w-full h-full backface-hidden rotate-y-180 rounded-xl shadow-2xl border-4 border-yellow-400 bg-white flex flex-col items-center justify-center p-6 relative overflow-hidden">
                        <div class="absolute inset-0 opacity-10 bg-[url('https://i.pinimg.com/originals/8f/c3/7b/8fc37b74b608a622588f7a214300c032.png')] bg-center bg-cover"></div>
                        
                        <h2 id="cardBack" class="text-4xl text-gray-800 handwritten font-bold text-center relative z-10 mb-4">...</h2>
                        
                        <div class="relative z-10 flex flex-col items-center gap-1">
                            <span class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Consonant Class</span>
                            <span id="cardClass" class="px-6 py-2 rounded-full text-lg font-bold text-white shadow-md transition-colors">
                                ...
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="controls" class="mt-8 flex gap-4 w-full max-w-md transition-opacity duration-300 opacity-0 pointer-events-none">
                
                <button id="learnBtn" onclick="toggleLearned(event)" class="flex-1 bg-gray-700 hover:bg-green-600 border border-gray-600 text-white font-bold py-3 rounded-lg shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-2">
                    <i id="learnIcon" class="ph-bold ph-brain"></i> 
                    <span id="learnText">Mark Learned</span>
                </button>

                <button id="nextBtn" onclick="handleNext()" class="flex-[2] bg-yellow-400 hover:bg-yellow-300 text-black font-bold py-3 px-8 rounded-lg shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-2">
                    NEXT <i class="ph-bold ph-arrow-right"></i>
                </button>
            </div>
        </div>

    </main>

    <script>
        const username = localStorage.getItem('username');
        if (!username) window.location.href = 'login.html';
        document.getElementById('userDisplay').textContent = username;

        let deck = [];
        let viewIndex = 0;
        let maxIndex = 0;
        let isFlipped = false;
        
        // Load learned cards from Storage (Set prevents duplicates)
        let learnedSet = new Set(JSON.parse(localStorage.getItem('learnedItems')) || []);

        async function initGame() {
            try {
                const res = await fetch('/all-flashcards');
                deck = await res.json();
                renderGrid();
                loadCard(0);
            } catch (e) {
                console.error(e);
                document.getElementById('cardFront').textContent = "Error";
            }
        }

        function renderGrid() {
            const grid = document.getElementById('gridContainer');
            grid.innerHTML = ''; 

            deck.forEach((card, index) => {
                const el = document.createElement('div');
                el.className = 'grid-item w-full aspect-square flex items-center justify-center rounded text-sm font-bold text-white/50';
                
                // CHECK IF MASTERED
                if (learnedSet.has(card.front)) {
                    el.classList.add('mastered');
                }

                if (index === viewIndex) {
                    el.classList.add('active');
                    el.textContent = card.front;
                } else if (index <= maxIndex) {
                    el.classList.add('unlocked');
                    el.textContent = card.front;
                    el.onclick = () => jumpToCard(index);
                } else {
                    el.textContent = '?';
                    el.style.cursor = 'default';
                }
                grid.appendChild(el);
            });
            
            document.getElementById('counter').textContent = `${maxIndex + 1}`;
            document.getElementById('masterCounter').textContent = learnedSet.size;
        }

        function loadCard(index) {
            viewIndex = index;
            if (viewIndex > maxIndex) maxIndex = viewIndex;

            const card = deck[index];
            document.getElementById('cardFront').textContent = card.front;
            document.getElementById('cardBack').textContent = card.back;
            
            // TONE COLOR LOGIC
            const classEl = document.getElementById('cardClass');
            const group = card.classGroup || "Unknown";
            classEl.textContent = group + " CLASS";
            classEl.classList.remove('bg-red-500', 'bg-green-500', 'bg-blue-600', 'bg-gray-500');
            if (group.startsWith("High")) classEl.classList.add('bg-red-500');
            else if (group.startsWith("Mid")) classEl.classList.add('bg-green-500');
            else if (group.startsWith("Low")) classEl.classList.add('bg-blue-600');
            else classEl.classList.add('bg-gray-500');

            // UPDATE LEARN BUTTON STATE
            updateLearnButtonState(card.front);

            // BUTTON LOGIC
            const btn = document.getElementById('nextBtn');
            if (viewIndex < maxIndex) {
                btn.innerHTML = 'RETURN <i class="ph-bold ph-arrow-u-up-right"></i>';
            } else if (viewIndex >= deck.length - 1) {
                btn.innerHTML = 'RESET? <i class="ph-bold ph-arrow-counter-clockwise"></i>';
            } else {
                btn.innerHTML = 'NEXT <i class="ph-bold ph-arrow-right"></i>';
            }

            renderGrid();
        }

        function updateLearnButtonState(char) {
            const btn = document.getElementById('learnBtn');
            const icon = document.getElementById('learnIcon');
            const text = document.getElementById('learnText');

            if (learnedSet.has(char)) {
                btn.classList.remove('bg-gray-700', 'hover:bg-green-600');
                btn.classList.add('bg-green-600');
                icon.className = "ph-bold ph-check-circle";
                text.textContent = "Learned";
            } else {
                btn.classList.add('bg-gray-700', 'hover:bg-green-600');
                btn.classList.remove('bg-green-600');
                icon.className = "ph-bold ph-brain";
                text.textContent = "Mark Learned";
            }
        }

        function toggleLearned(e) {
            e.stopPropagation(); // Prevent flipping card when clicking button
            const currentCard = deck[viewIndex];
            
            if (learnedSet.has(currentCard.front)) {
                learnedSet.delete(currentCard.front);
            } else {
                learnedSet.add(currentCard.front);
            }
            
            // Save to LocalStorage
            localStorage.setItem('learnedItems', JSON.stringify([...learnedSet]));
            
            // Update UI
            updateLearnButtonState(currentCard.front);
            renderGrid();
        }

        function jumpToCard(index) {
            isFlipped = false;
            document.getElementById('cardInner').classList.remove('flipped');
            document.getElementById('controls').classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => { loadCard(index); }, 200);
        }

        function flipCard() {
            isFlipped = !isFlipped;
            const cardInner = document.getElementById('cardInner');
            const controls = document.getElementById('controls');
            
            if (isFlipped) {
                cardInner.classList.add('flipped');
                controls.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                cardInner.classList.remove('flipped');
                controls.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        function handleNext() {
            isFlipped = false;
            document.getElementById('cardInner').classList.remove('flipped');
            document.getElementById('controls').classList.add('opacity-0', 'pointer-events-none');
            
            setTimeout(() => {
                if (viewIndex < maxIndex) {
                    loadCard(maxIndex); 
                } else {
                    let nextIndex = viewIndex + 1;
                    if (nextIndex >= deck.length) {
                        if(confirm("Mission Complete! Restart training?")) location.reload(); 
                    } else {
                        loadCard(nextIndex);
                    }
                }
            }, 300);
        }

        function logout() {
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        }

        initGame();
    </script>
</body>
</html>